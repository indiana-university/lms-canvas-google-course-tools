apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: "{{ .Release.Name }}-{{ .Values.batchJob }}"
  namespace: "{{ .Values.namespace }}"
spec:
  schedule: "{{ .Values.schedule }}"
  jobTemplate:
    spec:
      template:
        spec:
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{ if .Values.bootstrapSecret -}}
          volumes:
            - name: "bootstrap-secret"
              secret:
                secretName: {{ .Values.bootstrapSecret | quote }}
          {{- else if .Values.projectedSecret -}}
          volumes:
            - name: "bootstrap-secret"
              projected:
                sources:
                  {{- toYaml .Values.projectedSecret | nindent 18 }}
          {{- else -}}
          {{ end }}
          containers:
            - name: "{{ .Release.Name }}-{{ .Values.batchJob }}"
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: Always
              env:
                - name: JAVA_OPTS
                  value: {{ .Values.javaOpts | quote }}
                - name: SPRING_PROFILES_ACTIVE
                  value: "{{ .Values.activeProfiles }},batch,{{ .Values.batchJob }}"
                {{- range $key, $value := .Values.env }}
                - name: {{ $key | quote }}
                  value: {{ tpl $value $ | quote }}
                {{- end }}
              {{ if (or .Values.bootstrapSecret .Values.projectedSecret) -}}
              volumeMounts:
                - name: bootstrap-secret
                  mountPath: /usr/src/app/config
                  readOnly: true
              {{ end }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
          restartPolicy: Never
      backoffLimit: 4
